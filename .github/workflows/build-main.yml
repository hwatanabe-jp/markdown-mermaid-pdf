name: Build Main Branch

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  packages: write

env:
  IMAGE_NAME: markdown-mermaid-pdf

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image metadata
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          owner_lower="${GITHUB_REPOSITORY_OWNER,,}"
          image_repo="ghcr.io/${owner_lower}/${IMAGE_NAME}"
          echo "image_repo=${image_repo}" >>"$GITHUB_OUTPUT"

      - name: Build and push latest image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          tags: ${{ steps.meta.outputs.image_repo }}:latest

      - name: Verify pushed image manifest
        shell: bash
        run: |
          set -euo pipefail
          docker manifest inspect "${{ steps.meta.outputs.image_repo }}:latest"

      - name: Smoke test image functionality
        shell: bash
        run: |
          set -euo pipefail
          docker pull "${{ steps.meta.outputs.image_repo }}:latest"
          mkdir -p workspace
          rm -f workspace/test-output.pdf
          docker run --rm \
            -v "$PWD/workspace:/workspace" \
            "${{ steps.meta.outputs.image_repo }}:latest" \
            example.md test-output.pdf
          test -f workspace/test-output.pdf
          rm -f workspace/test-output.pdf

      - name: Smoke test pagebreak marker
        shell: bash
        run: |
          set -euo pipefail
          docker pull "${{ steps.meta.outputs.image_repo }}:latest"
          mkdir -p workspace
          printf '%s\n' '# CI Pagebreak check' '1st page text.' '' '<!-- pagebreak -->' '' '2nd page text.' > workspace/pagebreak-ci.md
          docker run --rm \
            -v "$PWD/workspace:/workspace" \
            "${{ steps.meta.outputs.image_repo }}:latest" \
            pagebreak-ci.md pagebreak-ci.pdf
          pages=$(docker run --rm \
            -v "$PWD/workspace:/workspace" \
            --entrypoint /bin/bash \
            "${{ steps.meta.outputs.image_repo }}:latest" \
            -c "pdfinfo pagebreak-ci.pdf | awk '/Pages/ {print \$2}'")
          if [ "${pages}" != "2" ]; then
            echo "Expected 2 pages, got ${pages}"
            exit 1
          fi
          rm -f workspace/pagebreak-ci.md workspace/pagebreak-ci.pdf
